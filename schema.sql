-- schema.sql

PRAGMA foreign_keys = OFF; -- Turn off checks temporarily for circular dependencies

DROP TABLE IF EXISTS TRANSACTIONS;
DROP TABLE IF EXISTS LOANS;
DROP TABLE IF EXISTS ACCOUNT_HOLDERS;
DROP TABLE IF EXISTS MONEYMARKET;
DROP TABLE IF EXISTS CHECKING;
DROP TABLE IF EXISTS SAVINGS;
DROP TABLE IF EXISTS DEPENDENTS;
DROP TABLE IF EXISTS ACCOUNTS;
DROP TABLE IF EXISTS CUSTOMER;
DROP TABLE IF EXISTS BRANCH;
DROP TABLE IF EXISTS EMPLOYEE;

-- 1. EMPLOYEE
CREATE TABLE EMPLOYEE (
    ESSN TEXT PRIMARY KEY,
    FName TEXT NOT NULL,
    MName TEXT,
    LName TEXT NOT NULL,
    PhoneNum TEXT,
    StartDate TEXT NOT NULL,
    LengthOfEmployment INTEGER,
    BranchID INTEGER,
    ManagerSSN TEXT,
    CHECK (LengthOfEmployment >= 0)
);

-- 2. BRANCH
CREATE TABLE BRANCH (
    BranchID INTEGER PRIMARY KEY,
    StreetNum TEXT,
    City TEXT NOT NULL,
    State TEXT NOT NULL,
    ZipCode TEXT NOT NULL,
    Name TEXT NOT NULL,
    ManagerSSN TEXT,
    AsstManagerSSN TEXT,
    FOREIGN KEY (ManagerSSN) REFERENCES EMPLOYEE(ESSN) ON DELETE SET NULL,
    FOREIGN KEY (AsstManagerSSN) REFERENCES EMPLOYEE(ESSN) ON DELETE SET NULL
);

-- 3. CUSTOMER (Added 'password' for web login capability)
CREATE TABLE CUSTOMER (
    CSSN TEXT PRIMARY KEY,
    FName TEXT NOT NULL,
    MName TEXT,
    LName TEXT NOT NULL,
    AptNum TEXT,
    StreetNum TEXT,
    City TEXT,
    State TEXT,
    ZipCode TEXT,
    PersonalBanker TEXT,
    AssociatedBranch INTEGER,
    Password TEXT DEFAULT '1234', -- Default password for demo
    FOREIGN KEY (PersonalBanker) REFERENCES EMPLOYEE(ESSN) ON DELETE SET NULL,
    FOREIGN KEY (AssociatedBranch) REFERENCES BRANCH(BranchID) ON DELETE SET NULL
);

-- 4. ACCOUNTS
CREATE TABLE ACCOUNTS (
    AccountNum INTEGER PRIMARY KEY,
    Balance REAL DEFAULT 0.00 NOT NULL,
    LastAccessDate TEXT,
    LastAccessBy TEXT,
    AccountType TEXT NOT NULL,
    FOREIGN KEY (LastAccessBy) REFERENCES CUSTOMER(CSSN) ON DELETE SET NULL,
    CHECK (AccountType IN ('Savings', 'Checking', 'MoneyMarket', 'Loan'))
);

-- 5. SUBTYPES (SAVINGS, CHECKING, etc.)
CREATE TABLE SAVINGS (
    AccountNum INTEGER PRIMARY KEY,
    FixedRate REAL NOT NULL,
    FOREIGN KEY (AccountNum) REFERENCES ACCOUNTS(AccountNum) ON DELETE CASCADE
);

CREATE TABLE CHECKING (
    AccountNum INTEGER PRIMARY KEY,
    Overdrafts INTEGER DEFAULT 0,
    FOREIGN KEY (AccountNum) REFERENCES ACCOUNTS(AccountNum) ON DELETE CASCADE
);

CREATE TABLE MONEYMARKET (
    AccountNum INTEGER PRIMARY KEY,
    VarRate REAL NOT NULL,
    FOREIGN KEY (AccountNum) REFERENCES ACCOUNTS(AccountNum) ON DELETE CASCADE
);

CREATE TABLE LOANS (
    AccountNum INTEGER PRIMARY KEY,
    LoanNum INTEGER NOT NULL,
    MonthlyPayment REAL NOT NULL,
    FixedRate REAL NOT NULL,
    Amount REAL NOT NULL,
    FOREIGN KEY (AccountNum) REFERENCES ACCOUNTS(AccountNum) ON DELETE CASCADE
);

-- 6. ACCOUNT_HOLDERS (Many-to-Many)
CREATE TABLE ACCOUNT_HOLDERS (
    AccountNum INTEGER NOT NULL,
    CSSN TEXT NOT NULL,
    PRIMARY KEY (AccountNum, CSSN),
    FOREIGN KEY (AccountNum) REFERENCES ACCOUNTS(AccountNum) ON DELETE CASCADE,
    FOREIGN KEY (CSSN) REFERENCES CUSTOMER(CSSN) ON DELETE CASCADE
);

-- 7. TRANSACTIONS
CREATE TABLE TRANSACTIONS (
    Code INTEGER PRIMARY KEY, -- Removed AUTOINCREMENT to match your hardcoded IDs
    Type TEXT NOT NULL,
    TransactionDate TEXT NOT NULL,
    Hour TEXT NOT NULL,
    Amount REAL NOT NULL,
    Chargeable TEXT DEFAULT 'Y',
    AccntNum INTEGER NOT NULL,
    FOREIGN KEY (AccntNum) REFERENCES ACCOUNTS(AccountNum) ON DELETE CASCADE,
    CHECK (Chargeable IN ('Y', 'N'))
);

-- 8. DEPENDENTS
CREATE TABLE DEPENDENTS (
    ESSN TEXT NOT NULL,
    FName TEXT NOT NULL,
    MName TEXT,
    LName TEXT NOT NULL,
    PRIMARY KEY (ESSN, FName, LName),
    FOREIGN KEY (ESSN) REFERENCES EMPLOYEE(ESSN) ON DELETE CASCADE
);

PRAGMA foreign_keys = ON;

-- --- DATA INSERTION ---

-- Employees
INSERT INTO EMPLOYEE VALUES ('100-01-0001', 'Alice', 'J', 'Smith', '555-1201', '2010-05-15', 15, NULL, NULL);
INSERT INTO EMPLOYEE VALUES ('200-02-0002', 'Bob', 'K', 'Johnson', '555-1202', '2015-08-20', 10, NULL, NULL);
INSERT INTO EMPLOYEE VALUES ('300-03-0003', 'Charlie', NULL, 'Brown', '555-1203', '2018-01-10', 7, NULL, NULL);
INSERT INTO EMPLOYEE VALUES ('400-04-0004', 'Diana', 'L', 'Miller', '555-1204', '2020-03-25', 5, NULL, NULL);
INSERT INTO EMPLOYEE VALUES ('500-05-0005', 'Ethan', 'M', 'Davis', '555-1205', '2022-11-01', 3, NULL, NULL);
INSERT INTO EMPLOYEE VALUES ('600-06-0006', 'Fiona', 'N', 'Garcia', '555-1206', '2023-01-01', 2, NULL, NULL);
INSERT INTO EMPLOYEE VALUES ('700-07-0007', 'Bob', 'N', 'Romeo', '555-6987', '2023-01-01', 2, NULL, NULL);

-- Branches
INSERT INTO BRANCH VALUES (1001, '450', 'New York', 'NY', '10001', 'Manhattan Central', '100-01-0001', '400-04-0004');
INSERT INTO BRANCH VALUES (1002, '123', 'Los Angeles', 'CA', '90001', 'LA Coast', '200-02-0002', '600-06-0006');
INSERT INTO BRANCH VALUES (1003, '789', 'Chicago', 'IL', '60601', 'Midwest Hub', '300-03-0003', '200-02-0002');
INSERT INTO BRANCH VALUES (1004, '101', 'Miami', 'FL', '33101', 'Sunshine Branch', '500-05-0005', '300-03-0003');
INSERT INTO BRANCH VALUES (1005, '202', 'Houston', 'TX', '77001', 'Space City Finance', '400-04-0004', '500-05-0005');

-- Update Employees (Circular Fix)
UPDATE EMPLOYEE SET BranchID = 1001, ManagerSSN = NULL WHERE ESSN = '100-01-0001';
UPDATE EMPLOYEE SET BranchID = 1002, ManagerSSN = '100-01-0001' WHERE ESSN = '200-02-0002';
UPDATE EMPLOYEE SET BranchID = 1003, ManagerSSN = '100-01-0001' WHERE ESSN = '300-03-0003';
UPDATE EMPLOYEE SET BranchID = 1001, ManagerSSN = '200-02-0002' WHERE ESSN = '400-04-0004';
UPDATE EMPLOYEE SET BranchID = 1004, ManagerSSN = '300-03-0003' WHERE ESSN = '500-05-0005';
UPDATE EMPLOYEE SET BranchID = 1002, ManagerSSN = '200-02-0002' WHERE ESSN = '600-06-0006';
UPDATE EMPLOYEE SET BranchID = 1002, ManagerSSN = '200-02-0002' WHERE ESSN = '700-07-0007';

-- Customers (Added Default Password '1234')
INSERT INTO CUSTOMER VALUES ('900-01-1000', 'Grace', 'O', 'White', '1A', '300', 'New York', 'NY', '10001', '400-04-0004', 1001, '1234');
INSERT INTO CUSTOMER VALUES ('900-02-1001', 'Henry', NULL, 'King', '4B', '1500', 'Los Angeles', 'CA', '90001', '200-02-0002', 1002, '1234');
INSERT INTO CUSTOMER VALUES ('900-03-1002', 'Ivy', 'P', 'Lee', '10C', '808', 'Chicago', 'IL', '60601', '300-03-0003', 1003, '1234');
INSERT INTO CUSTOMER VALUES ('900-04-1003', 'Jack', 'Q', 'Hall', NULL, '404', 'Miami', 'FL', '33101', '500-05-0005', 1004, '1234');
INSERT INTO CUSTOMER VALUES ('900-05-1004', 'Kelly', NULL, 'Adams', '22', '909', 'Houston', 'TX', '77001', '400-04-0004', 1005, '1234');

-- Accounts
INSERT INTO ACCOUNTS VALUES (500001, 15000.00, '2025-11-18', '900-01-1000', 'Savings');
INSERT INTO ACCOUNTS VALUES (500002, 800.61, '2025-11-18', '900-01-1000', 'Checking');
INSERT INTO ACCOUNTS VALUES (500003, 2568.56, '2025-11-18', '900-01-1000', 'MoneyMarket');
INSERT INTO ACCOUNTS VALUES (500004, -3587.52, '2025-11-18', '900-01-1000', 'Loan');
INSERT INTO ACCOUNTS VALUES (500005, 1200.00, '2025-07-13', '900-02-1001', 'Savings');
INSERT INTO ACCOUNTS VALUES (500006, 80.61, '2025-01-10', '900-02-1001', 'Checking');
INSERT INTO ACCOUNTS VALUES (500007, 28.56, '2025-02-15', '900-02-1001', 'MoneyMarket');
INSERT INTO ACCOUNTS VALUES (500008, -2150.52, '2025-03-03', '900-02-1001', 'Loan');
INSERT INTO ACCOUNTS VALUES (500009, 5000.00, '2025-03-08', '900-03-1002', 'Savings');
INSERT INTO ACCOUNTS VALUES (500010, 56.10, '2025-04-22', '900-03-1002', 'Checking');
INSERT INTO ACCOUNTS VALUES (500011, 80000.80, '2025-08-29', '900-03-1002', 'MoneyMarket');
INSERT INTO ACCOUNTS VALUES (500012, -65000.00, '2025-05-02', '900-03-1002', 'Loan');
INSERT INTO ACCOUNTS VALUES (500013, 10000.00, '2025-10-31', '900-04-1003', 'Savings');
INSERT INTO ACCOUNTS VALUES (500014, 4520.20, '2025-06-23', '900-04-1003', 'Checking');
INSERT INTO ACCOUNTS VALUES (500015, 300.45, '2025-01-29', '900-04-1003', 'MoneyMarket');
INSERT INTO ACCOUNTS VALUES (500016, -12865.32, '2025-08-21', '900-04-1003', 'Loan');
INSERT INTO ACCOUNTS VALUES (500017, 500.00, '2025-11-02', '900-05-1004', 'Savings');
INSERT INTO ACCOUNTS VALUES (500018, 5000.50, '2025-02-12', '900-05-1004', 'Checking');
INSERT INTO ACCOUNTS VALUES (500019, 6523.35, '2025-03-13', '900-05-1004', 'MoneyMarket');
INSERT INTO ACCOUNTS VALUES (500020, -100.50, '2025-03-13', '900-05-1004', 'Loan');

-- Subtypes
INSERT INTO SAVINGS VALUES (500001, 0.0150);
INSERT INTO SAVINGS VALUES (500005, 0.0150);
INSERT INTO SAVINGS VALUES (500009, 0.4000);
INSERT INTO SAVINGS VALUES (500013, 0.0130);
INSERT INTO SAVINGS VALUES (500017, 0.0150);

INSERT INTO CHECKING VALUES (500002, 0);
INSERT INTO CHECKING VALUES (500006, 1);
INSERT INTO CHECKING VALUES (500010, 5);
INSERT INTO CHECKING VALUES (500014, 3);
INSERT INTO CHECKING VALUES (500018, 0);

INSERT INTO MONEYMARKET VALUES (500003, 0.0250);
INSERT INTO MONEYMARKET VALUES (500007, 0.0250);
INSERT INTO MONEYMARKET VALUES (500011, 0.0250);
INSERT INTO MONEYMARKET VALUES (500015, 0.0250);
INSERT INTO MONEYMARKET VALUES (500019, 0.0250);

INSERT INTO LOANS VALUES (500004, 5021, 550.00, 0.0400, 10000.00);
INSERT INTO LOANS VALUES (500008, 6321, 385.00, 0.0800, 5000.00);
INSERT INTO LOANS VALUES (500012, 9852, 458.65, 0.0300, 75000.00);
INSERT INTO LOANS VALUES (500016, 1023, 200.00, 0.0500, 13000.00);
INSERT INTO LOANS VALUES (500020, 6974, 693.55, 0.1000, 2000.00);

-- Account Holders
INSERT INTO ACCOUNT_HOLDERS VALUES (500001, '900-01-1000');
INSERT INTO ACCOUNT_HOLDERS VALUES (500002, '900-01-1000');
INSERT INTO ACCOUNT_HOLDERS VALUES (500003, '900-01-1000');
INSERT INTO ACCOUNT_HOLDERS VALUES (500004, '900-01-1000');
INSERT INTO ACCOUNT_HOLDERS VALUES (500005, '900-02-1001');
INSERT INTO ACCOUNT_HOLDERS VALUES (500006, '900-02-1001');
INSERT INTO ACCOUNT_HOLDERS VALUES (500007, '900-02-1001');
INSERT INTO ACCOUNT_HOLDERS VALUES (500008, '900-02-1001');
INSERT INTO ACCOUNT_HOLDERS VALUES (500009, '900-03-1002');
INSERT INTO ACCOUNT_HOLDERS VALUES (500010, '900-03-1002');
INSERT INTO ACCOUNT_HOLDERS VALUES (500011, '900-03-1002');
INSERT INTO ACCOUNT_HOLDERS VALUES (500012, '900-03-1002');
INSERT INTO ACCOUNT_HOLDERS VALUES (500013, '900-04-1003');
INSERT INTO ACCOUNT_HOLDERS VALUES (500014, '900-04-1003');
INSERT INTO ACCOUNT_HOLDERS VALUES (500015, '900-04-1003');
INSERT INTO ACCOUNT_HOLDERS VALUES (500016, '900-04-1003');
INSERT INTO ACCOUNT_HOLDERS VALUES (500017, '900-05-1004');
INSERT INTO ACCOUNT_HOLDERS VALUES (500018, '900-05-1004');
INSERT INTO ACCOUNT_HOLDERS VALUES (500019, '900-05-1004');
INSERT INTO ACCOUNT_HOLDERS VALUES (500020, '900-05-1004');

-- Dependents
INSERT INTO DEPENDENTS VALUES ('100-01-0001', 'Peter', 'Robert', 'Smith');
INSERT INTO DEPENDENTS VALUES ('100-01-0001', 'Jane', 'Ellen', 'Smith');
INSERT INTO DEPENDENTS VALUES ('200-02-0002', 'Sam', 'Ian', 'Johnson');
INSERT INTO DEPENDENTS VALUES ('400-04-0004', 'Laura', 'Marie', 'Miller');
INSERT INTO DEPENDENTS VALUES ('400-04-0004', 'Mark', NULL, 'Miller');

-- Transactions
INSERT INTO TRANSACTIONS VALUES (1, 'CD', '2025-11-18', '10:00:00', 500.00, 'N', 500001);
INSERT INTO TRANSACTIONS VALUES (2, 'WD', '2025-11-18', '11:30:00', 100.00, 'N', 500002);
INSERT INTO TRANSACTIONS VALUES (3, 'CD', '2025-11-16', '03:00:00', 150.00, 'N', 500003);
INSERT INTO TRANSACTIONS VALUES (4, 'CD', '2025-11-18', '13:45:00', 550.00, 'N', 500004);
INSERT INTO TRANSACTIONS VALUES (5, 'WD', '2025-11-15', '16:20:00', 3.00, 'Y', 500005);
INSERT INTO TRANSACTIONS VALUES (6, 'WD', '2025-11-18', '19:00:00', 20.00, 'N', 500005);